@page "/contact"
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Contact> Logger

<PageTitle>Ä°letiÅŸim - MyDictionary</PageTitle>

<div class="contact-container">
    <div class="contact-header">
        <h1>Ä°letiÅŸim</h1>
        <p>gÃ¶rÃ¼ÅŸ, Ã¶neri ve ÅŸikayetlerinizi bizimle paylaÅŸÄ±n</p>
    </div>

    <div class="contact-content">
        <div class="contact-info">
            <div class="info-card">
                <h3>ğŸ“§ e-posta</h3>
                <p>iletisim@mydictionary.com</p>
                <small>genel sorular ve Ã¶neriler iÃ§in</small>
            </div>

            <div class="info-card">
                <h3>ğŸš¨ acil durumlar</h3>
                <p>abuse@mydictionary.com</p>
                <small>spam, hakaret ve kural ihlalleri iÃ§in</small>
            </div>

            <div class="info-card">
                <h3>ğŸ’¼ iÅŸ birliÄŸi</h3>
                <p>partnership@mydictionary.com</p>
                <small>reklam ve sponsorluk teklifleri iÃ§in</small>
            </div>

            <div class="info-card">
                <h3>ğŸ”§ teknik destek</h3>
                <p>support@mydictionary.com</p>
                <small>site sorunlarÄ± ve hata bildirimleri iÃ§in</small>
            </div>
        </div>

        <div class="contact-form-section">
            <h2>mesaj gÃ¶nder</h2>
            <p>formu doldurarak doÄŸrudan bizimle iletiÅŸime geÃ§ebilirsiniz. mesajÄ±nÄ±z en geÃ§ 48 saat iÃ§inde yanÄ±tlanacaktÄ±r.</p>

            <EditForm Model="@contactModel" OnSubmit="@HandleSubmit" FormName="ContactForm">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="name">adÄ±nÄ±z soyadÄ±nÄ±z</label>
                    <InputText @bind-Value="contactModel.Name" 
                              class="form-control" 
                              id="name" 
                              placeholder="Ad Soyad" />
                    <ValidationMessage For="@(() => contactModel.Name)" />
                </div>

                <div class="form-group">
                    <label for="email">e-posta adresiniz</label>
                    <InputText @bind-Value="contactModel.Email" 
                              class="form-control" 
                              id="email" 
                              type="email"
                              placeholder="ornek@email.com" />
                    <ValidationMessage For="@(() => contactModel.Email)" />
                </div>

                <div class="form-group">
                    <label for="subject">konu</label>
                    <InputSelect @bind-Value="contactModel.Subject" 
                                class="form-control" 
                                id="subject">
                        <option value="">konu seÃ§in</option>
                        <option value="general">genel soru/Ã¶neri</option>
                        <option value="bug">hata bildirimi</option>
                        <option value="feature">Ã¶zellik talebi</option>
                        <option value="abuse">kural ihlali bildirimi</option>
                        <option value="account">hesap sorunu</option>
                        <option value="content">iÃ§erik sorunu</option>
                        <option value="technical">teknik destek</option>
                        <option value="other">diÄŸer</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => contactModel.Subject)" />
                </div>

                @if (contactModel.Subject == "abuse")
                {
                    <div class="form-group">
                        <label for="reportedUser">ÅŸikayet edilen kullanÄ±cÄ±</label>
                        <InputText @bind-Value="contactModel.ReportedUser" 
                                  class="form-control" 
                                  id="reportedUser" 
                                  placeholder="kullanÄ±cÄ± adÄ± (isteÄŸe baÄŸlÄ±)" />
                    </div>

                    <div class="form-group">
                        <label for="reportedContent">ÅŸikayet edilen iÃ§erik url'si</label>
                        <InputText @bind-Value="contactModel.ReportedContentUrl" 
                                  class="form-control" 
                                  id="reportedContent" 
                                  placeholder="entry veya konu url'si (isteÄŸe baÄŸlÄ±)" />
                    </div>
                }

                <div class="form-group">
                    <label for="message">mesajÄ±nÄ±z</label>
                    <InputTextArea @bind-Value="contactModel.Message" 
                                   class="form-control" 
                                   id="message" 
                                   rows="6"
                                   placeholder="mesajÄ±nÄ±zÄ± buraya yazÄ±n..." />
                    <ValidationMessage For="@(() => contactModel.Message)" />
                    <div class="char-count">@(1000 - contactModel.Message.Length) karakter kaldÄ±</div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <InputCheckbox @bind-Value="contactModel.AcceptPrivacy" />
                        <span>kiÅŸisel verilerimin iÅŸlenmesini kabul ediyorum</span>
                    </label>
                    <ValidationMessage For="@(() => contactModel.AcceptPrivacy)" />
                    <small>mesajÄ±nÄ±zÄ±n yanÄ±tlanabilmesi iÃ§in gereklidir</small>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">
                        @errorMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success">
                        @successMessage
                    </div>
                }

                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner"></span>
                        <span>gÃ¶nderiliyor...</span>
                    }
                    else
                    {
                        <span>mesaj gÃ¶nder</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>

    <div class="faq-section">
        <h2>sÄ±k sorulan sorular</h2>
        
        <div class="faq-item">
            <h4>hesabÄ±mÄ± nasÄ±l silebilirim?</h4>
            <p>hesap silme iÅŸlemi iÃ§in teknik destek ekibimizle iletiÅŸime geÃ§in. support@mydictionary.com adresine e-posta gÃ¶ndererek talebinizi iletebilirsiniz.</p>
        </div>

        <div class="faq-item">
            <h4>entry'mi neden silindi?</h4>
            <p>entry'niz <a href="/rules">sÃ¶zlÃ¼k kurallarÄ±na</a> aykÄ±rÄ± bulunmuÅŸ olabilir. ayrÄ±ntÄ±lÄ± bilgi iÃ§in moderasyon ekibimizle iletiÅŸime geÃ§ebilirsiniz.</p>
        </div>

        <div class="faq-item">
            <h4>ÅŸifremi unuttum nasÄ±l sÄ±fÄ±rlayabilirim?</h4>
            <p>giriÅŸ sayfasÄ±ndaki "ÅŸifremi unuttum" linkine tÄ±klayarak ÅŸifre sÄ±fÄ±rlama iÅŸlemini baÅŸlatabilirsiniz.</p>
        </div>

        <div class="faq-item">
            <h4>reklam vermek istiyorum nasÄ±l baÅŸvurabilirim?</h4>
            <p>reklam ve sponsorluk teklifleriniz iÃ§in partnership@mydictionary.com adresine e-posta gÃ¶nderebilirsiniz.</p>
        </div>

        <div class="faq-item">
            <h4>mobil uygulama var mÄ±?</h4>
            <p>ÅŸu anda mobil uygulamamÄ±z bulunmuyor ancak site mobil uyumlu olarak tasarlanmÄ±ÅŸtÄ±r. ilerleyen dÃ¶nemlerde mobil uygulama planlarÄ±mÄ±z var.</p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private ContactModel contactModel { get; set; } = new();
    private string errorMessage = "";
    private string successMessage = "";
    private bool isSubmitting = false;

    public class ContactModel
    {
        [Required(ErrorMessage = "Ad soyad gereklidir")]
        [StringLength(100, ErrorMessage = "Ad soyad en fazla 100 karakter olabilir")]
        public string Name { get; set; } = "";

        [Required(ErrorMessage = "E-posta adresi gereklidir")]
        [EmailAddress(ErrorMessage = "GeÃ§erli bir e-posta adresi girin")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Konu seÃ§imi gereklidir")]
        public string Subject { get; set; } = "";

        [Required(ErrorMessage = "Mesaj gereklidir")]
        [StringLength(1000, MinimumLength = 10, ErrorMessage = "Mesaj 10-1000 karakter arasÄ±nda olmalÄ±dÄ±r")]
        public string Message { get; set; } = "";

        public string? ReportedUser { get; set; }
        public string? ReportedContentUrl { get; set; }

        [Required(ErrorMessage = "KiÅŸisel veri iÅŸleme onayÄ± gereklidir")]
        [Range(typeof(bool), "true", "true", ErrorMessage = "KiÅŸisel veri iÅŸleme onayÄ± vermelisiniz")]
        public bool AcceptPrivacy { get; set; }
    }

    private async Task HandleSubmit(EditContext editContext)
    {
        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("ğŸš€ Ä°LETÄ°ÅÄ°M FORMU GÃ–NDERÄ°LÄ°YOR");
            Logger.LogInformation($"ğŸ“ Form Verileri - Name: '{contactModel.Name}', Email: '{contactModel.Email}', Subject: '{contactModel.Subject}'");
            
            // Validation kontrolÃ¼
            if (!editContext.Validate())
            {
                Logger.LogWarning("âŒ VALÄ°DASYON HATASI - Form validation baÅŸarÄ±sÄ±z");
                var validationMessages = editContext.GetValidationMessages().ToList();
                foreach (var message in validationMessages)
                {
                    Logger.LogWarning($"â— Validation Error: {message}");
                }
                errorMessage = "LÃ¼tfen tÃ¼m gerekli alanlarÄ± doÄŸru ÅŸekilde doldurun.";
                return;
            }
            
            Logger.LogInformation("âœ… VALÄ°DASYON BAÅARILI");
            Logger.LogInformation("ğŸŒ API Ã‡AÄRISI BAÅLADI");
            
            // API Ã§aÄŸrÄ±sÄ±
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            var contactDto = new
            {
                Name = contactModel.Name,
                Email = contactModel.Email,
                Subject = contactModel.Subject,
                Message = contactModel.Message,
                ReportedUser = contactModel.ReportedUser,
                ReportedContentUrl = contactModel.ReportedContentUrl,
                AcceptPrivacy = contactModel.AcceptPrivacy
            };

            var json = JsonSerializer.Serialize(contactDto);
            Logger.LogInformation($"ğŸ“¤ Contact API JSON: {json}");
            
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            try
            {
                // Contact API endpoint'i oluÅŸturulacak
                Logger.LogInformation("ğŸ”— API URL: https://apiservice/api/contact");
                var response = await httpClient.PostAsync("https://apiservice/api/contact", content);
                var responseContent = await response.Content.ReadAsStringAsync();
                
                Logger.LogInformation($"ğŸ“¥ API Response Status: {response.StatusCode}");
                Logger.LogInformation($"ğŸ“¥ API Response Content: {responseContent}");

                if (response.IsSuccessStatusCode)
                {
                    Logger.LogInformation("ğŸ‰ MESAJ BAÅARIYLA GÃ–NDERÄ°LDÄ°!");
                    successMessage = "MesajÄ±nÄ±z baÅŸarÄ±yla gÃ¶nderildi! En geÃ§ 48 saat iÃ§inde size dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.";
                    
                    // Form'u temizle
                    contactModel = new ContactModel();
                    StateHasChanged();
                }
                else
                {
                    Logger.LogError($"âŒ API HATASI - Status: {response.StatusCode}");
                    errorMessage = "Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin veya doÄŸrudan e-posta gÃ¶nderin.";
                }
            }
            catch (HttpRequestException httpEx)
            {
                Logger.LogError($"âŒ HTTP Ä°STEK HATASI: {httpEx.Message}");
                // API yoksa doÄŸrudan baÅŸarÄ± mesajÄ± gÃ¶ster (geliÅŸtirme aÅŸamasÄ±nda)
                Logger.LogInformation("ğŸ“§ E-posta simÃ¼lasyonu - Mesaj baÅŸarÄ±yla alÄ±ndÄ±");
                successMessage = "MesajÄ±nÄ±z baÅŸarÄ±yla gÃ¶nderildi! En geÃ§ 48 saat iÃ§inde size dÃ¶nÃ¼ÅŸ yapacaÄŸÄ±z.";
                contactModel = new ContactModel();
                StateHasChanged();
            }
            catch (TaskCanceledException timeoutEx)
            {
                Logger.LogError($"âŒ TIMEOUT HATASI: {timeoutEx.Message}");
                errorMessage = "Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ±. LÃ¼tfen tekrar deneyin.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"ğŸ’¥ GENEL HATA: {ex.Message}");
            Logger.LogError($"ğŸ’¥ Stack Trace: {ex.StackTrace}");
            errorMessage = $"Beklenmeyen hata: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            Logger.LogInformation("ğŸ Ä°LETÄ°ÅÄ°M FORMU Ä°ÅLEMÄ° TAMAMLANDI");
        }
    }
}

