@page "/login"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text
@using MyDictionary.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Login> Logger
@inject NavigationManager Navigation
@inject AuthenticationStateService AuthService
@inject IJSRuntime JSRuntime

<PageTitle>GiriÅŸ Yap - MyDictionary</PageTitle>


<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>MyDictionary'ye GiriÅŸ Yap</h2>
            <p>HesabÄ±nÄ±za giriÅŸ yapÄ±n ve topluluÄŸa katÄ±lÄ±n</p>
        </div>

        <EditForm Model="@loginModel" OnSubmit="@HandleLogin" FormName="LoginForm">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="email">E-posta Adresi</label>
                <InputText @bind-Value="loginModel.Email" 
                          class="form-control" 
                          id="email" 
                          type="email"
                          placeholder="E-posta adresinizi girin" />
                <ValidationMessage For="@(() => loginModel.Email)" />
            </div>

            <div class="form-group">
                <label for="password">Åifre</label>
                <InputText @bind-Value="loginModel.Password" 
                          class="form-control" 
                          id="password" 
                          type="password"
                          placeholder="Åifrenizi girin" />
                <ValidationMessage For="@(() => loginModel.Password)" />
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <InputCheckbox @bind-Value="loginModel.RememberMe" />
                    <span>Beni hatÄ±rla</span>
                </label>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-error">
                    @errorMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    @successMessage
                </div>
            }

            <button type="submit" class="btn btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner"></span>
                    <span>GiriÅŸ yapÄ±lÄ±yor...</span>
                }
                else
                {
                    <span>GiriÅŸ Yap</span>
                }
            </button>
        </EditForm>

        <div class="login-footer">
            <p><a href="/forgot-password" class="forgot-link">Åifremi unuttum</a></p>
            <p>HesabÄ±nÄ±z yok mu? <a href="/register">KayÄ±t olun</a></p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginModel loginModel { get; set; } = new();
    private string errorMessage = "";
    private string successMessage = "";
    private bool isLoading = false;
    private bool shouldNavigateAfterRender = false;

    public class LoginModel
    {
        [Required(ErrorMessage = "E-posta adresi gereklidir")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Åifre gereklidir")]
        public string Password { get; set; } = "";

        public bool RememberMe { get; set; }
    }

    private async Task HandleLogin(EditContext editContext)
    {
        isLoading = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("ğŸš€ GÄ°RÄ°Å Ä°ÅLEMÄ° BAÅLADI");
            Logger.LogInformation($"ğŸ“ GiriÅŸ Verileri - Email: '{loginModel.Email}', RememberMe: {loginModel.RememberMe}");
            
            // Ã–nce validation kontrolÃ¼ yap
            if (!editContext.Validate())
            {
                Logger.LogWarning("âŒ VALÄ°DASYON HATASI - Form validation baÅŸarÄ±sÄ±z");
                var validationMessages = editContext.GetValidationMessages().ToList();
                foreach (var message in validationMessages)
                {
                    Logger.LogWarning($"â— Validation Error: {message}");
                }
                isLoading = false;
                errorMessage = "LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru ÅŸekilde doldurun.";
                return;
            }
            
            Logger.LogInformation("âœ… VALÄ°DASYON BAÅARILI - TÃ¼m alanlar geÃ§erli");
            Logger.LogInformation("ğŸŒ API Ã‡AÄRISI BAÅLADI");
            
            // API Ã§aÄŸrÄ±sÄ±
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            var loginDto = new
            {
                UsernameOrEmail = loginModel.Email,
                Password = loginModel.Password
            };

            var json = JsonSerializer.Serialize(loginDto);
            Logger.LogInformation($"ğŸ“¤ Login API JSON: {json}");
            
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            try
            {
                Logger.LogInformation("ğŸ”— API URL: https://apiservice/api/auth/login");
                var response = await httpClient.PostAsync("https://apiservice/api/auth/login", content);
                var responseContent = await response.Content.ReadAsStringAsync();
                
                Logger.LogInformation($"ğŸ“¥ API Response Status: {response.StatusCode}");
                Logger.LogInformation($"ğŸ“¥ API Response Content: {responseContent}");

                if (response.IsSuccessStatusCode)
                {
                    Logger.LogInformation("ğŸ‰ GÄ°RÄ°Å BAÅARILI!");
                    
                    AuthenticationStateService.UserInfo? userInfo = null;
                    string token = "";
                    bool shouldNavigate = false;
                    
                    try
                    {
                        var authResponse = JsonSerializer.Deserialize<JsonElement>(responseContent);
                        if (authResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                        {
                            if (authResponse.TryGetProperty("user", out var userElement))
                            {
                                // KullanÄ±cÄ± bilgilerini parse et
                                userInfo = new AuthenticationStateService.UserInfo
                                {
                                    Id = userElement.GetProperty("id").GetInt32(),
                                    Username = userElement.GetProperty("username").GetString() ?? "",
                                    Email = userElement.GetProperty("email").GetString() ?? "",
                                    BirthDate = userElement.GetProperty("birthDate").GetDateTime(),
                                    Gender = userElement.GetProperty("gender").GetInt32(),
                                    Role = userElement.GetProperty("role").GetString() ?? "",
                                    CreatedAt = userElement.GetProperty("createdAt").GetDateTime(),
                                    LastLoginAt = userElement.TryGetProperty("lastLoginAt", out var lastLoginElement) 
                                        ? lastLoginElement.GetDateTime() : null
                                };
                                
                                Logger.LogInformation($"ğŸ‘¤ KullanÄ±cÄ± bilgileri alÄ±ndÄ±: {userInfo.Username}");
                                
                                // Token'Ä± al
                                if (authResponse.TryGetProperty("token", out var tokenElement))
                                {
                                    token = tokenElement.GetString() ?? "";
                                    Logger.LogInformation($"ğŸ”‘ Token alÄ±ndÄ± (uzunluk: {token.Length})");
                                }
                                
                                shouldNavigate = true;
                            }
                        }
                        else
                        {
                            Logger.LogWarning("âŒ API Success=false dÃ¶ndÃ¼");
                            if (authResponse.TryGetProperty("message", out var messageElement))
                            {
                                errorMessage = messageElement.GetString() ?? "GiriÅŸ baÅŸarÄ±sÄ±z.";
                            }
                            else
                            {
                                errorMessage = "GiriÅŸ baÅŸarÄ±sÄ±z.";
                            }
                        }
                    }
                    catch (Exception jsonEx)
                    {
                        Logger.LogError($"âŒ JSON Parse Error: {jsonEx.Message}");
                        errorMessage = "Sunucu yanÄ±t formatÄ± hatalÄ±.";
                    }
                    
                    // Navigation'Ä± try-catch dÄ±ÅŸÄ±nda yap
                    if (shouldNavigate && userInfo != null)
                    {
                        // Authentication state'i ayarla
                        await AuthService.SetUserAsync(userInfo, token);
                        Logger.LogInformation($"ğŸ” AuthService user set - IsAuthenticated: {AuthService.IsAuthenticated}");
                        
                        Logger.LogInformation("ğŸš€ GiriÅŸ baÅŸarÄ±lÄ±, navigation yapÄ±lacak...");
                        
                        // Sadece OnAfterRenderAsync ile navigation yap
                        shouldNavigateAfterRender = true;
                        StateHasChanged();
                    }
                }
                else
                {
                    Logger.LogError($"âŒ API HATASI - Status: {response.StatusCode}");
                    try
                    {
                        var errorResponse = JsonSerializer.Deserialize<JsonElement>(responseContent);
                        if (errorResponse.TryGetProperty("message", out var messageElement))
                        {
                            var apiErrorMessage = messageElement.GetString() ?? "GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu.";
                            Logger.LogError($"âŒ API Error Message: {apiErrorMessage}");
                            errorMessage = apiErrorMessage;
                        }
                        else
                        {
                            Logger.LogError("âŒ API Error: Message property bulunamadÄ±");
                            errorMessage = "E-posta/kullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±.";
                        }
                    }
                    catch (Exception jsonEx)
                    {
                        Logger.LogError($"âŒ JSON Parse Error: {jsonEx.Message}");
                        errorMessage = "E-posta/kullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±.";
                    }
                }
            }
            catch (HttpRequestException httpEx)
            {
                Logger.LogError($"âŒ HTTP Ä°STEK HATASI: {httpEx.Message}");
                errorMessage = $"BaÄŸlantÄ± hatasÄ±: {httpEx.Message}";
            }
            catch (TaskCanceledException timeoutEx)
            {
                Logger.LogError($"âŒ TIMEOUT HATASI: {timeoutEx.Message}");
                errorMessage = "Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ±. LÃ¼tfen tekrar deneyin.";
            }
        }
        catch (Microsoft.AspNetCore.Components.NavigationException navEx)
        {
            Logger.LogInformation($"ğŸ”„ Top-level navigation exception (beklenen): {navEx.Message}");
            // NavigationException normal davranÄ±ÅŸ, navigation baÅŸarÄ±lÄ± demektir
            // Bu exception'Ä± hata olarak gÃ¶stermeyelim
        }
        catch (Exception ex)
        {
            Logger.LogError($"ğŸ’¥ GENEL HATA: {ex.Message}");
            Logger.LogError($"ğŸ’¥ Stack Trace: {ex.StackTrace}");
            errorMessage = $"Beklenmeyen hata: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            Logger.LogInformation("ğŸ GÄ°RÄ°Å Ä°ÅLEMÄ° TAMAMLANDI");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldNavigateAfterRender)
        {
            Logger.LogInformation("ğŸ”„ OnAfterRenderAsync Ã§aÄŸrÄ±ldÄ±, navigation yapÄ±lacak");
            shouldNavigateAfterRender = false;
            await PerformNavigation();
        }
    }

    private async Task PerformNavigation()
    {
        try
        {
            Logger.LogInformation("ğŸ”„ Navigation baÅŸlatÄ±lÄ±yor...");
            await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/'");
            Logger.LogInformation("âœ… JavaScript navigation baÅŸarÄ±lÄ±");
        }
        catch (Exception ex)
        {
            Logger.LogError($"âŒ JavaScript navigation hatasÄ±: {ex.Message}");
            
            // Fallback: Normal Blazor navigation
            try
            {
                Navigation.NavigateTo("/", forceLoad: true);
                Logger.LogInformation("âœ… Fallback Blazor navigation baÅŸarÄ±lÄ±");
            }
            catch (Microsoft.AspNetCore.Components.NavigationException)
            {
                Logger.LogInformation("ğŸ”„ NavigationException (normal)");
            }
            catch (Exception navEx)
            {
                Logger.LogError($"âŒ Fallback navigation hatasÄ±: {navEx.Message}");
                successMessage = "GiriÅŸ baÅŸarÄ±lÄ±! Anasayfaya gitmek iÃ§in sayfa yenileyin.";
                StateHasChanged();
            }
        }
    }

}