@page "/profile/{username}"
@page "/profile"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using System.Text
@using MyDictionary.Web.Services
@inject ILogger<Profile> Logger
@inject AuthenticationStateService AuthService
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime

<PageTitle>@GetPageTitle() - MyDictionary</PageTitle>

<div class="profile-container">
    <div class="profile-content">
        <!-- Sol Kolon - Kullanƒ±cƒ± Bilgileri -->
        <div class="profile-sidebar">
            <div class="user-info-card">
                <div class="profile-photo-section">
                    <div class="profile-photo">
                        @if (!string.IsNullOrEmpty(currentUser.ProfilePhotoUrl))
                        {
                            <img src="https://apiservice/uploads/profiles/@currentUser.ProfilePhotoUrl" alt="@currentUser.Username" />
                        }
                        else
                        {
                            <div class="default-avatar">
                                @GetInitials(currentUser.Username)
                            </div>
                        }
                        @if (IsOwnProfile())
                        {
                            <button class="photo-edit-btn" @onclick="OpenPhotoUpload">
                                <span class="edit-icon">üì∑</span>
                            </button>
                        }
                    </div>
                    
                    @if (showPhotoUpload)
                    {
                        <div class="photo-upload-modal">
                            <div class="upload-content">
                                <h4>Profil Fotoƒürafƒ± Y√ºkle</h4>
                                <InputFile OnChange="HandlePhotoUpload" accept="image/*" />
                                <div class="upload-actions">
                                    <button class="btn btn-primary" @onclick="UploadPhoto" disabled="@isUploadingPhoto">
                                        @if (isUploadingPhoto)
                                        {
                                            <span>Y√ºkleniyor...</span>
                                        }
                                        else
                                        {
                                            <span>Y√ºkle</span>
                                        }
                                    </button>
                                    <button class="btn btn-secondary" @onclick="ClosePhotoUpload">ƒ∞ptal</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="user-details">
                    <div class="user-header">
                        <h2 class="username">@currentUser.Username</h2>
                        @if (!IsOwnProfile() && AuthService.IsAuthenticated)
                        {
                            <div class="profile-actions">
                                @if (relationshipStatus == "friend")
                                {
                                    <button class="btn btn-friends" disabled>
                                        ‚úì arkada≈ü
                                    </button>
                                    <button class="btn btn-message" @onclick="SendMessage">
                                        mesaj g√∂nder
                                    </button>
                                }
                                else if (relationshipStatus == "request_sent")
                                {
                                    <button class="btn btn-pending" disabled>
                                        istek g√∂nderildi
                                    </button>
                                }
                                else if (relationshipStatus == "request_received")
                                {
                                    <button class="btn btn-accept" @onclick="AcceptFriendRequest">
                                        arkada≈ülƒ±ƒüƒ± kabul et
                                    </button>
                                    <button class="btn btn-reject" @onclick="RejectFriendRequest">
                                        reddet
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-add-friend" @onclick="SendFriendRequest">
                                        arkada≈ü ekle
                                    </button>
                                }
                            </div>
                        }
                    </div>
                    <p class="join-date">@currentUser.CreatedAt.ToString("MMMM yyyy")'dan beri √ºye</p>
                    
                    <div class="stats-grid">
                        <div class="stat-item clickable" @onclick="ShowEntries">
                            <span class="stat-number">@currentUser.EntryCount</span>
                            <span class="stat-label">entry</span>
                        </div>
                        
                        <div class="stat-item clickable" @onclick="ShowFollowers">
                            <span class="stat-number">@currentUser.FollowerCount</span>
                            <span class="stat-label">takip√ßi</span>
                        </div>
                        
                        <div class="stat-item clickable" @onclick="ShowFollowing">
                            <span class="stat-number">@currentUser.FollowingCount</span>
                            <span class="stat-label">takip</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saƒü Kolon - Entry ve Favoriler -->
        <div class="profile-main">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn @(activeTab == "entries" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("entries"))">
                        girdiƒüim entry'ler
                    </button>
                    <button class="tab-btn @(activeTab == "favorites" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("favorites"))">
                        favori entry'lerim
                    </button>
                </div>

                <div class="tab-content">
                    @if (activeTab == "entries")
                    {
                        <div class="entries-list">
                            @if (userEntries.Any())
                            {
                                @foreach (var entry in userEntries)
                                {
                                    <div class="entry-item">
                                        <div class="entry-header">
                                            <a href="/topic/@entry.TopicSlug" class="entry-topic">@entry.TopicTitle</a>
                                            <span class="entry-date">@entry.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                                        </div>
                                        <div class="entry-content">
                                            @entry.Content
                                        </div>
                                        <div class="entry-stats">
                                            <span class="vote-count">@entry.VoteCount oy</span>
                                            <span class="favorite-count">@entry.FavoriteCount favori</span>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-state">
                                    <p>hen√ºz hi√ß entry girmemi≈üsiniz.</p>
                                    <a href="/" class="btn btn-primary">entry yazmaya ba≈üla</a>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="favorites-list">
                            @if (favoriteEntries.Any())
                            {
                                @foreach (var entry in favoriteEntries)
                                {
                                    <div class="entry-item">
                                        <div class="entry-header">
                                            <a href="/topic/@entry.TopicSlug" class="entry-topic">@entry.TopicTitle</a>
                                            <span class="entry-author">@entry.AuthorUsername</span>
                                            <span class="entry-date">@entry.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                                        </div>
                                        <div class="entry-content">
                                            @entry.Content
                                        </div>
                                        <div class="entry-stats">
                                            <span class="vote-count">@entry.VoteCount oy</span>
                                            <button class="unfavorite-btn" @onclick="() => RemoveFromFavorites(entry.Id)">
                                                favorilerden √ßƒ±kar
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-state">
                                    <p>hen√ºz hi√ß entry favorilemediniz.</p>
                                    <a href="/" class="btn btn-primary">entry'leri ke≈üfet</a>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Alt Kƒ±sƒ±m - Hakkƒ±mda -->
    <div class="about-section">
        <div class="about-card">
            <h3>hakkƒ±mda</h3>
            @if (isEditingAbout)
            {
                <div class="about-edit">
                    <textarea @bind="aboutText" placeholder="kendinizi tanƒ±tƒ±n..." rows="6" maxlength="500"></textarea>
                    <div class="char-count">@(500 - aboutText.Length) karakter kaldƒ±</div>
                    <div class="about-actions">
                        <button class="btn btn-primary" @onclick="SaveAbout" disabled="@isSavingAbout">
                            @if (isSavingAbout)
                            {
                                <span>kaydediliyor...</span>
                            }
                            else
                            {
                                <span>kaydet</span>
                            }
                        </button>
                        <button class="btn btn-secondary" @onclick="CancelEditAbout">iptal</button>
                    </div>
                </div>
            }
            else
            {
                <div class="about-display">
                    @if (!string.IsNullOrEmpty(currentUser.About))
                    {
                        <p>@currentUser.About</p>
                    }
                    else
                    {
                        <p class="empty-about">hen√ºz bir tanƒ±tƒ±m yazmadƒ±nƒ±z.</p>
                    }
                    @if (IsOwnProfile())
                    {
                        <button class="btn btn-outline" @onclick="StartEditAbout">d√ºzenle</button>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Takip√ßi/Takip Modali -->
@if (showFollowModal)
{
    <div class="modal-overlay" @onclick="CloseFollowModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4>@followModalTitle</h4>
                <button class="modal-close" @onclick="CloseFollowModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (followModalUsers.Any())
                {
                    @foreach (var user in followModalUsers)
                    {
                        <div class="user-item">
                            <div class="user-avatar">
                                @if (!string.IsNullOrEmpty(user.ProfilePhotoUrl))
                                {
                                    <img src="@user.ProfilePhotoUrl" alt="@user.Username" />
                                }
                                else
                                {
                                    <div class="default-avatar-small">@GetInitials(user.Username)</div>
                                }
                            </div>
                            <div class="user-info">
                                <a href="/user/@user.Username" class="user-link">@user.Username</a>
                                <span class="user-stats">@user.EntryCount entry</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="empty-state">hen√ºz kimse yok.</p>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string username { get; set; } = "";
    
    private UserProfileModel currentUser = new();
    private List<EntryModel> userEntries = new();
    private List<EntryModel> favoriteEntries = new();
    private List<UserModel> followModalUsers = new();
    
    private string activeTab = "entries";
    private bool showPhotoUpload = false;
    private bool isUploadingPhoto = false;
    private bool isEditingAbout = false;
    private bool isSavingAbout = false;
    private bool showFollowModal = false;
    private string followModalTitle = "";
    private string aboutText = "";
    private IBrowserFile? selectedPhoto;
    private bool isFollowing = false;
    private string relationshipStatus = "none"; // none, friend, request_sent, request_received
    private int? pendingRequestId = null;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("üìÑ Profile sayfasƒ± y√ºkleniyor...");
        
        // √ñnce AuthService'i initialize et
        await AuthService.InitializeAsync();
        
        // Eƒüer username parametresi yoksa, kendi profiline y√∂nlendir
        if (string.IsNullOrEmpty(username) && AuthService.IsAuthenticated)
        {
            username = AuthService.CurrentUser?.Username ?? "";
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Parameter deƒüi≈ütiƒüinde profili yeniden y√ºkle
        if (!string.IsNullOrEmpty(username))
        {
            await LoadUserProfile();
            await LoadUserEntries();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // localStorage'dan kullanƒ±cƒ± bilgilerini y√ºkle
            await AuthService.LoadFromStorageAsync();
            
            Logger.LogInformation($"üîê AuthService.IsAuthenticated: {AuthService.IsAuthenticated}");
            Logger.LogInformation($"üë§ AuthService.CurrentUser: {AuthService.CurrentUser?.Username ?? "null"}");
            
            // Eƒüer giri≈ü yapƒ±lmamƒ±≈üsa login sayfasƒ±na y√∂nlendir
            if (!AuthService.IsAuthenticated)
            {
                Logger.LogWarning("‚ùå Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü, login sayfasƒ±na y√∂nlendiriliyor");
                Navigation.NavigateTo("/login");
                return;
            }

            Logger.LogInformation("‚úÖ Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü, profil y√ºkleniyor");
            await LoadUserProfile();
            await LoadUserEntries();
            StateHasChanged();
        }
    }

    private async Task LoadUserProfile()
    {
        try
        {
            Logger.LogInformation($"üìÑ Profile API √ßaƒürƒ±sƒ± ba≈ülatƒ±lƒ±yor - Username: {username}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var response = await httpClient.GetAsync($"https://apiservice/api/profile/{username}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (apiResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                {
                    if (apiResponse.TryGetProperty("user", out var userElement))
                    {
                        currentUser = new UserProfileModel
                        {
                            Id = userElement.GetProperty("id").GetInt32(),
                            Username = userElement.GetProperty("username").GetString() ?? "",
                            ProfilePhotoUrl = userElement.TryGetProperty("profilePhotoUrl", out var photoElement) ? photoElement.GetString() : null,
                            CreatedAt = userElement.GetProperty("createdAt").GetDateTime(),
                            EntryCount = userElement.GetProperty("entryCount").GetInt32(),
                            FollowerCount = userElement.GetProperty("followerCount").GetInt32(),
                            FollowingCount = userElement.GetProperty("followingCount").GetInt32(),
                            About = userElement.TryGetProperty("about", out var aboutElement) ? aboutElement.GetString() : null
                        };
                        
                        aboutText = currentUser.About ?? "";
                        Logger.LogInformation($"‚úÖ Profile API'den y√ºklendi: {currentUser.Username}");
                        
                        // ƒ∞li≈üki durumunu kontrol et (sadece ba≈üka kullanƒ±cƒ±lar i√ßin)
                        if (!IsOwnProfile() && AuthService.IsAuthenticated)
                        {
                            await LoadRelationshipStatus();
                        }
                    }
                }
            }
            else
            {
                Logger.LogError($"‚ùå Profile API hatasƒ± - Status: {response.StatusCode}");
                currentUser = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Profil y√ºkleme hatasƒ±: {ex.Message}");
            currentUser = null;
        }
    }

    private async Task LoadUserEntries()
    {
        // Simulated data - API √ßaƒürƒ±sƒ± ile deƒüi≈ütirilecek
        userEntries = new List<EntryModel>
        {
            new() { Id = 1, TopicTitle = "asp.net core", TopicSlug = "asp-net-core", Content = "modern web uygulamalarƒ± geli≈ütirmek i√ßin harika bir framework...", CreatedAt = DateTime.Now.AddDays(-5), VoteCount = 12, FavoriteCount = 3 },
            new() { Id = 2, TopicTitle = "clean code", TopicSlug = "clean-code", Content = "okunabilir kod yazmak sanƒ±ldƒ±ƒüƒ±ndan √ßok daha √∂nemli...", CreatedAt = DateTime.Now.AddDays(-10), VoteCount = 8, FavoriteCount = 2 }
        };

        favoriteEntries = new List<EntryModel>
        {
            new() { Id = 3, TopicTitle = "design patterns", TopicSlug = "design-patterns", Content = "singleton pattern neden k√∂t√º olarak kabul ediliyor?", AuthorUsername = "architect_dev", CreatedAt = DateTime.Now.AddDays(-3), VoteCount = 15, FavoriteCount = 7 }
        };
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
    }

    private void OpenPhotoUpload()
    {
        showPhotoUpload = true;
    }

    private void ClosePhotoUpload()
    {
        showPhotoUpload = false;
        selectedPhoto = null;
    }

    private void HandlePhotoUpload(InputFileChangeEventArgs e)
    {
        selectedPhoto = e.File;
    }

    private async Task UploadPhoto()
    {
        if (selectedPhoto == null || !IsOwnProfile()) return;

        isUploadingPhoto = true;
        try
        {
            Logger.LogInformation($"üì∑ Profil fotoƒürafƒ± y√ºkleme ba≈ülatƒ±lƒ±yor: {selectedPhoto.Name}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            // MultipartFormDataContent olu≈ütur
            using var formData = new MultipartFormDataContent();
            using var fileStream = selectedPhoto.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB limit
            using var streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedPhoto.ContentType);
            formData.Add(streamContent, "photo", selectedPhoto.Name);
            
            var response = await httpClient.PostAsync("https://apiservice/api/profile/upload-photo", formData);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (apiResponse.TryGetProperty("photoUrl", out var photoElement))
                {
                    currentUser.ProfilePhotoUrl = photoElement.GetString();
                    Logger.LogInformation($"‚úÖ Profil fotoƒürafƒ± y√ºklendi: {selectedPhoto.Name}");
                }
                
                ClosePhotoUpload();
            }
            else
            {
                Logger.LogError($"‚ùå Profil fotoƒürafƒ± y√ºkleme hatasƒ± - Status: {response.StatusCode}");
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå Error Content: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Profil fotoƒürafƒ± y√ºkleme hatasƒ±: {ex.Message}");
        }
        finally
        {
            isUploadingPhoto = false;
        }
    }

    private void StartEditAbout()
    {
        isEditingAbout = true;
        aboutText = currentUser.About ?? "";
    }

    private void CancelEditAbout()
    {
        isEditingAbout = false;
        aboutText = currentUser.About ?? "";
    }

    private async Task SaveAbout()
    {
        if (!IsOwnProfile()) return;
        
        isSavingAbout = true;
        try
        {
            Logger.LogInformation("üìù About g√ºncelleme API √ßaƒürƒ±sƒ± ba≈ülatƒ±lƒ±yor");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var updateRequest = new { About = aboutText };
            var json = JsonSerializer.Serialize(updateRequest);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await httpClient.PutAsync("https://apiservice/api/profile/update", content);
            
            if (response.IsSuccessStatusCode)
            {
                currentUser.About = aboutText;
                isEditingAbout = false;
                Logger.LogInformation("‚úÖ About ba≈üarƒ±yla g√ºncellendi");
            }
            else
            {
                Logger.LogError($"‚ùå About g√ºncelleme hatasƒ± - Status: {response.StatusCode}");
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå Error Content: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå About g√ºncelleme hatasƒ±: {ex.Message}");
        }
        finally
        {
            isSavingAbout = false;
        }
    }

    private async Task ShowFollowers()
    {
        followModalTitle = "takip√ßilerim";
        // API √ßaƒürƒ±sƒ± ile takip√ßi listesi y√ºklenecek
        followModalUsers = new List<UserModel>
        {
            new() { Username = "frontend_dev", EntryCount = 23, ProfilePhotoUrl = "" },
            new() { Username = "backend_master", EntryCount = 156, ProfilePhotoUrl = "" }
        };
        showFollowModal = true;
    }

    private async Task ShowFollowing()
    {
        followModalTitle = "takip ettiklerim";
        // API √ßaƒürƒ±sƒ± ile takip edilen liste y√ºklenecek
        followModalUsers = new List<UserModel>
        {
            new() { Username = "code_guru", EntryCount = 89, ProfilePhotoUrl = "" },
            new() { Username = "tech_writer", EntryCount = 67, ProfilePhotoUrl = "" }
        };
        showFollowModal = true;
    }

    private async Task ShowEntries()
    {
        activeTab = "entries";
    }

    private void CloseFollowModal()
    {
        showFollowModal = false;
        followModalUsers.Clear();
    }

    private async Task RemoveFromFavorites(int entryId)
    {
        // API √ßaƒürƒ±sƒ± ile favorilerden √ßƒ±karma i≈ülemi
        favoriteEntries = favoriteEntries.Where(e => e.Id != entryId).ToList();
        Logger.LogInformation($"Entry {entryId} favorilerden √ßƒ±karƒ±ldƒ±");
    }

    private string GetInitials(string username)
    {
        if (string.IsNullOrEmpty(username)) return "?";
        return username.Length >= 2 ? username.Substring(0, 2).ToUpper() : username.ToUpper();
    }

    private bool IsOwnProfile()
    {
        return AuthService.IsAuthenticated && 
               AuthService.CurrentUser?.Username?.Equals(username, StringComparison.OrdinalIgnoreCase) == true;
    }

    private string GetPageTitle()
    {
        if (string.IsNullOrEmpty(username))
            return "Profil";
        
        return IsOwnProfile() ? "Profilim" : $"{username} - Profil";
    }

    private async Task ToggleFollow()
    {
        isFollowing = !isFollowing;
        // API √ßaƒürƒ±sƒ± burada yapƒ±lacak
        Logger.LogInformation($"{username} kullanƒ±cƒ±sƒ± {(isFollowing ? "takip edildi" : "takibi bƒ±rakƒ±ldƒ±")}");
    }

    private async Task SendMessage()
    {
        // Mesaj sayfasƒ±na y√∂nlendirme
        Navigation.NavigateTo($"/messages/{username}");
    }

    private async Task LoadRelationshipStatus()
    {
        try
        {
            if (currentUser == null) return;
            
            Logger.LogInformation($"üë• ƒ∞li≈üki durumu kontrol ediliyor - {username}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await httpClient.GetAsync($"https://apiservice/api/user/{currentUser.Id}/relationship");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (apiResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                {
                    if (apiResponse.TryGetProperty("relationship", out var relationshipElement))
                    {
                        relationshipStatus = relationshipElement.GetString() ?? "none";
                        
                        if (relationshipStatus == "request_received" && apiResponse.TryGetProperty("requestId", out var requestIdElement))
                        {
                            pendingRequestId = requestIdElement.GetInt32();
                        }
                        
                        Logger.LogInformation($"‚úÖ ƒ∞li≈üki durumu: {relationshipStatus}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå ƒ∞li≈üki durumu y√ºkleme hatasƒ±: {ex.Message}");
        }
    }

    private async Task SendFriendRequest()
    {
        try
        {
            if (currentUser == null) return;
            
            Logger.LogInformation($"üëã Arkada≈ülƒ±k isteƒüi g√∂nderiliyor - {username}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var requestData = new { ReceiverId = currentUser.Id };
            var json = JsonSerializer.Serialize(requestData);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            
            var response = await httpClient.PostAsync("https://apiservice/api/friends/send-request", content);
            
            if (response.IsSuccessStatusCode)
            {
                relationshipStatus = "request_sent";
                Logger.LogInformation($"‚úÖ Arkada≈ülƒ±k isteƒüi g√∂nderildi - {username}");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi g√∂nderme hatasƒ±: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi g√∂nderme hatasƒ±: {ex.Message}");
        }
    }

    private async Task AcceptFriendRequest()
    {
        try
        {
            if (pendingRequestId == null) return;
            
            Logger.LogInformation($"‚úÖ Arkada≈ülƒ±k isteƒüi kabul ediliyor - RequestId: {pendingRequestId}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await httpClient.PostAsync($"https://apiservice/api/friends/{pendingRequestId}/accept", null);
            
            if (response.IsSuccessStatusCode)
            {
                relationshipStatus = "friend";
                pendingRequestId = null;
                // Takip√ßi sayƒ±sƒ±nƒ± artƒ±r
                if (currentUser != null)
                {
                    currentUser.FollowerCount++;
                }
                Logger.LogInformation($"‚úÖ Arkada≈ülƒ±k isteƒüi kabul edildi - {username}");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi kabul etme hatasƒ±: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi kabul etme hatasƒ±: {ex.Message}");
        }
    }

    private async Task RejectFriendRequest()
    {
        try
        {
            if (pendingRequestId == null) return;
            
            Logger.LogInformation($"‚ùå Arkada≈ülƒ±k isteƒüi reddediliyor - RequestId: {pendingRequestId}");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            
            // JWT token'ƒ± header'a ekle
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
            
            var response = await httpClient.PostAsync($"https://apiservice/api/friends/{pendingRequestId}/reject", null);
            
            if (response.IsSuccessStatusCode)
            {
                relationshipStatus = "none";
                pendingRequestId = null;
                Logger.LogInformation($"‚ùå Arkada≈ülƒ±k isteƒüi reddedildi - {username}");
                StateHasChanged();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi reddetme hatasƒ±: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Arkada≈ülƒ±k isteƒüi reddetme hatasƒ±: {ex.Message}");
        }
    }

    public class UserProfileModel
    {
        public int Id { get; set; }
        public string Username { get; set; } = "";
        public string? ProfilePhotoUrl { get; set; }
        public DateTime CreatedAt { get; set; }
        public int EntryCount { get; set; }
        public int FollowerCount { get; set; }
        public int FollowingCount { get; set; }
        public string? About { get; set; }
    }

    public class EntryModel
    {
        public int Id { get; set; }
        public string TopicTitle { get; set; } = "";
        public string TopicSlug { get; set; } = "";
        public string Content { get; set; } = "";
        public string? AuthorUsername { get; set; }
        public DateTime CreatedAt { get; set; }
        public int VoteCount { get; set; }
        public int FavoriteCount { get; set; }
    }

    public class UserModel
    {
        public string Username { get; set; } = "";
        public string? ProfilePhotoUrl { get; set; }
        public int EntryCount { get; set; }
    }
}

