@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using System.Text.Json
@using MyDictionary.Web.Services
@inject AuthenticationStateService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime _jsRuntime
@inject ILogger<Header> Logger
@inject IHttpClientFactory HttpClientFactory
@implements IDisposable

<header class="main-header">
    <div class="header-container">
        <!-- Logo ve Site Adƒ± -->
        <div class="logo-section">
            <a href="/" class="logo-link">
                <img src="/favicon.png" alt="MyDictionary Logo" class="logo" />
                <span class="site-name">MyDictionary</span>
            </a>
        </div>

        <!-- Arama Kutusu -->
        <div class="search-section">
            <div class="search-container" @onclick:stopPropagation="true">
                <input type="text" 
                       class="search-input" 
                       placeholder="kullanƒ±cƒ± ara..."
                       @bind="SearchQuery"
                       @onkeypress="HandleSearchKeyPress"
                       @oninput="HandleSearchInput" />
                <button class="search-button" @onclick="HandleSearch">
                    <span class="search-icon">üîç</span>
                </button>
                
                @if (showSearchResults)
                {
                    <div class="search-dropdown" @onclick:stopPropagation="true">
                        @if (searchResults.Any())
                        {
                            @foreach (var user in searchResults)
                            {
                                <div class="search-result-item" @onclick="() => NavigateToProfile(user.Username)">
                                    <div class="user-avatar-small">
                                        @if (!string.IsNullOrEmpty(user.ProfilePhotoUrl))
                                        {
                                            <img src="/uploads/profiles/@user.ProfilePhotoUrl" alt="@user.Username" />
                                        }
                                        else
                                        {
                                            <div class="default-avatar-mini">@GetUserInitials(user.Username)</div>
                                        }
                                    </div>
                                    <div class="user-info">
                                        <div class="username">@user.Username</div>
                                        <div class="email">@user.Email</div>
                                        <div class="user-stats">@user.EntryCount entry ‚Ä¢ @user.FollowerCount takip√ßi</div>
                                    </div>
                                </div>
                            }
                            @if (searchResults.Count >= 5)
                            {
                                <div class="search-more" @onclick="ViewAllResults">
                                    T√ºm sonu√ßlarƒ± g√∂r...
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-search-results">
                                <span class="no-results-icon">üîç</span>
                                <span class="no-results-text">"@SearchQuery" i√ßin sonu√ß bulunamadƒ±</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Giri≈ü ve Kayƒ±t Butonlarƒ± / Kullanƒ±cƒ± Men√ºs√º -->
        <div class="auth-section">
            @if (AuthService.IsAuthenticated)
            {
                <div class="user-menu">
                    <div class="user-actions">
                        <button class="notification-button" @onclick="ToggleNotifications" title="bildirimler">
                            <span class="notification-icon">üîî</span>
                            @if (unreadNotificationCount > 0)
                            {
                                <span class="notification-badge">@unreadNotificationCount</span>
                            }
                        </button>
                        <button class="message-button" @onclick="NavigateToMessages" title="mesajlar">
                            <span class="message-icon">üí¨</span>
                            @if (unreadMessageCount > 0)
                            {
                                <span class="message-badge">@unreadMessageCount</span>
                            }
                        </button>
                        @if (AuthService.IsAuthenticated)
                        {
                            <a href="/newtopic" class="new-topic-button" title="ba≈ülƒ±k a√ß">
                                <span class="new-topic-icon">‚ûï</span>
                                <span class="new-topic-text">ba≈ülƒ±k a√ß</span>
                            </a>
                        }
                        <button class="user-button" @onclick="ToggleUserDropdown">
                            <span class="user-name">@(AuthService.CurrentUser?.Username ?? "ben")</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                    </div>
                    
                    @if (showNotifications)
                    {
                        <div class="notifications-dropdown" @onclick:stopPropagation="true">
                            <div class="notifications-header">
                                <h4>Bildirimler</h4>
                                @if (notifications.Any(n => !n.IsRead))
                                {
                                    <button class="mark-all-read-btn" @onclick="MarkAllNotificationsRead">
                                        t√ºm√ºn√º okundu i≈üaretle
                                    </button>
                                }
                            </div>
                            <div class="notifications-body">
                                @if (notifications.Any())
                                {
                                    @foreach (var notification in notifications.Take(10))
                                    {
                                        <div class="notification-item @(!notification.IsRead ? "unread" : "")" @onclick="() => HandleNotificationClick(notification)">
                                            <div class="notification-content">
                                                @if (notification.FromUser != null)
                                                {
                                                    <div class="notification-avatar">
                                                        @if (!string.IsNullOrEmpty(notification.FromUser.ProfilePhotoUrl))
                                                        {
                                                            <img src="/uploads/profiles/@notification.FromUser.ProfilePhotoUrl" alt="@notification.FromUser.Username" />
                                                        }
                                                        else
                                                        {
                                                            <div class="default-avatar-mini">@GetUserInitials(notification.FromUser.Username)</div>
                                                        }
                                                    </div>
                                                }
                                                <div class="notification-text">
                                                    <p>@notification.Content</p>
                                                    <span class="notification-time">@GetTimeAgo(notification.CreatedAt)</span>
                                                </div>
                                            </div>
                                            @if (!notification.IsRead)
                                            {
                                                <div class="unread-indicator"></div>
                                            }
                                        </div>
                                    }
                                    @if (notifications.Count > 10)
                                    {
                                        <div class="view-all-notifications" @onclick="ViewAllNotifications">
                                            T√ºm bildirimleri g√∂r...
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="no-notifications">
                                        <span>üîî</span>
                                        <p>Hen√ºz bildirim yok</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (showUserDropdown)
                    {
                        <div class="user-dropdown" @onclick:stopPropagation="true">
                            <button class="dropdown-item" @onclick="@(() => CloseDropdownAndNavigate($"/profile/{AuthService.CurrentUser?.Username}"))">
                                <span class="dropdown-icon">üë§</span>
                                profil
                            </button>
                            <button class="dropdown-item" @onclick="@(() => CloseDropdownAndNavigate("/settings"))">
                                <span class="dropdown-icon">‚öôÔ∏è</span>
                                ayarlar
                            </button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item logout-item" @onclick="HandleLogout">
                                <span class="dropdown-icon">üö™</span>
                                √ßƒ±kƒ±≈ü yap
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <a href="/login" class="auth-link login-link">giri≈ü</a>
                <a href="/register" class="auth-link register-link">kayƒ±t ol</a>
            }
        </div>
    </div>

    <!-- Kategori Navigasyonu -->
    <nav class="category-nav">
        <div class="category-container">
            @foreach (var category in categories.Take(12))
            {
                <a href="/category/@category.Slug" class="category-link">@category.Name</a>
            }
        </div>
    </nav>
</header>

@code {
    private string SearchQuery = "";
    private bool showUserDropdown = false;
    private bool showSearchResults = false;
    private bool showNotifications = false;
    private List<UserSearchResult> searchResults = new();
    private List<NotificationResult> notifications = new();
    private List<CategoryResult> categories = new();
    private int unreadNotificationCount = 0;
    private int unreadMessageCount = 0;
    private System.Threading.Timer? searchTimer;
    private System.Threading.Timer? notificationTimer;
    private bool isManualSearch = false;
    private bool isSearching = false;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("üîÑ Header OnInitializedAsync ba≈ülatƒ±ldƒ±");
        // AuthService'i initialize et
        await AuthService.InitializeAsync();
        AuthService.OnAuthenticationChanged += StateHasChanged;
        Logger.LogInformation($"üîê Header Initialize - IsAuthenticated: {AuthService.IsAuthenticated}, User: {AuthService.CurrentUser?.Username ?? "null"}");
        
        // Kategorileri y√ºkle
        await LoadCategories();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogInformation("üîÑ Header OnAfterRenderAsync (firstRender) ba≈ülatƒ±ldƒ±");
            // ƒ∞lk render sonrasƒ± localStorage'dan kullanƒ±cƒ± bilgilerini y√ºkle
            await AuthService.LoadFromStorageAsync();
            Logger.LogInformation($"üîê Header AfterRender - IsAuthenticated: {AuthService.IsAuthenticated}, User: {AuthService.CurrentUser?.Username ?? "null"}");
            
            
            // Bildirimlarƒ± ve mesajlarƒ± y√ºkle ve periyodik olarak kontrol et
            if (AuthService.IsAuthenticated)
            {
                await LoadNotifications();
                await LoadUnreadMessageCount();
                StartNotificationTimer();
            }
            
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        AuthService.OnAuthenticationChanged -= StateHasChanged;
        searchTimer?.Dispose();
        notificationTimer?.Dispose();
    }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        SearchQuery = e.Value?.ToString() ?? "";
        
        // Timer'ƒ± iptal et
        searchTimer?.Dispose();
        
        // Manuel arama devam ediyorsa input aramayƒ± engelle
        if (isManualSearch)
        {
            Logger.LogInformation("‚ö†Ô∏è Manuel arama devam ediyor, input arama engellendi");
            return;
        }
        
        if (string.IsNullOrWhiteSpace(SearchQuery) || SearchQuery.Length < 2)
        {
            showSearchResults = false;
            StateHasChanged();
            return;
        }
        
        // 300ms delay ile arama yap (sadece input search i√ßin)
        searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!isManualSearch && !isSearching) // Double check
                {
                    await SearchUsers();
                    StateHasChanged();
                }
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task HandleSearch()
    {
        if (isSearching)
        {
            Logger.LogInformation("‚ö†Ô∏è Arama zaten devam ediyor, duplicate call engellendi");
            return;
        }

        if (!string.IsNullOrWhiteSpace(SearchQuery) && SearchQuery.Length >= 2)
        {
            isSearching = true;
            isManualSearch = true;
            
            // Timer'ƒ± iptal et (input search ile conflict √∂nlemek i√ßin)
            searchTimer?.Dispose();
            
            Logger.LogInformation($"üîç Manuel arama ba≈ülatƒ±lƒ±yor: '{SearchQuery}'");
            
            try
            {
                await SearchUsers();
                
                // Manuel aramada her zaman dropdown'ƒ± g√∂ster
                showSearchResults = true;
                if (searchResults.Any())
                {
                    Logger.LogInformation($"‚úÖ Manuel arama dropdown g√∂steriliyor: {searchResults.Count} sonu√ß");
                }
                else
                {
                    Logger.LogInformation("‚ö†Ô∏è Manuel arama sonucu bulunamadƒ± ama dropdown g√∂steriliyor");
                }
                StateHasChanged();
            }
            finally
            {
                isSearching = false;
                isManualSearch = false;
            }
        }
        else
        {
            Logger.LogInformation("‚ö†Ô∏è Manuel arama: terim √ßok kƒ±sa (min 2 karakter)");
            showSearchResults = false;
            StateHasChanged();
        }
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Logger.LogInformation("‚å®Ô∏è Enter tu≈üu basƒ±ldƒ±");
            
            // Input search timer'ƒ±nƒ± iptal et
            searchTimer?.Dispose();
            
            if (!isSearching)
            {
                Logger.LogInformation("‚å®Ô∏è Enter ile manuel arama ba≈ülatƒ±lƒ±yor");
                await HandleSearch();
            }
            else
            {
                Logger.LogInformation("‚å®Ô∏è Enter basƒ±ldƒ± ama arama zaten devam ediyor");
            }
        }
        else if (e.Key == "Escape")
        {
            Logger.LogInformation("‚å®Ô∏è Escape tu≈üu basƒ±ldƒ±, dropdown kapatƒ±lƒ±yor");
            searchTimer?.Dispose();
            showSearchResults = false;
            SearchQuery = "";
            StateHasChanged();
        }
    }

    private async Task SearchUsers()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(SearchQuery) || SearchQuery.Length < 2)
            {
                showSearchResults = false;
                return;
            }

            Logger.LogInformation($"üîç Header'da kullanƒ±cƒ± arama ba≈ülatƒ±ldƒ±: '{SearchQuery}'");
            
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var searchUrl = $"https://apiservice/api/user/search?query={Uri.EscapeDataString(SearchQuery)}&pageSize=5";
            Logger.LogInformation($"üåê API URL: {searchUrl}");
            
            var response = await httpClient.GetAsync(searchUrl);
            Logger.LogInformation($"üì° API Response Status: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                Logger.LogInformation($"üì• API Response Content: {content}");
                
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (apiResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                {
                    if (apiResponse.TryGetProperty("users", out var usersElement))
                    {
                        searchResults.Clear();
                        
                        foreach (var userElement in usersElement.EnumerateArray())
                        {
                            var newUser = new UserSearchResult
                            {
                                Id = userElement.GetProperty("id").GetInt32(),
                                Username = userElement.GetProperty("username").GetString() ?? "",
                                Email = userElement.TryGetProperty("email", out var emailElement) ? emailElement.GetString() ?? "" : "",
                                ProfilePhotoUrl = userElement.TryGetProperty("profilePhotoUrl", out var photoElement) ? photoElement.GetString() : null,
                                EntryCount = userElement.GetProperty("entryCount").GetInt32(),
                                FollowerCount = userElement.GetProperty("followerCount").GetInt32()
                            };
                            
                            searchResults.Add(newUser);
                            Logger.LogInformation($"üë§ Kullanƒ±cƒ± eklendi: {newUser.Username} (ID: {newUser.Id})");
                        }
                        
                        // Manuel arama deƒüilse, sonu√ß varsa dropdown g√∂ster
                        if (!isManualSearch)
                        {
                            showSearchResults = searchResults.Any();
                        }
                        Logger.LogInformation($"‚úÖ Arama tamamlandƒ±: {searchResults.Count} kullanƒ±cƒ± bulundu, showSearchResults: {showSearchResults}");
                        
                        // DEBUG: State deƒüerlerini detaylƒ± logla
                        Logger.LogInformation($"üéØ DEBUG - showSearchResults: {showSearchResults}");
                        Logger.LogInformation($"üéØ DEBUG - searchResults.Count: {searchResults.Count}");
                        Logger.LogInformation($"üéØ DEBUG - searchResults.Any(): {searchResults.Any()}");
                        foreach (var user in searchResults)
                        {
                            Logger.LogInformation($"üéØ DEBUG - User: {user.Username}, ID: {user.Id}");
                        }
                        
                        // KRITIK: UI'ƒ± g√ºncellemeyi zorla
                        StateHasChanged();
                        Logger.LogInformation($"üîÑ StateHasChanged() √ßaƒürƒ±ldƒ±!");
                    }
                    else
                    {
                        Logger.LogWarning("‚ö†Ô∏è API response'da 'users' property bulunamadƒ±");
                    }
                }
                else
                {
                    Logger.LogWarning("‚ö†Ô∏è API success=false d√∂nd√ºrd√º");
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"‚ùå API hata d√∂nd√ºrd√º: {response.StatusCode} - {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Kullanƒ±cƒ± arama hatasƒ±: {ex.Message}");
            Logger.LogError($"‚ùå Stack trace: {ex.StackTrace}");
        }
    }

    private void NavigateToProfile(string username)
    {
        try
        {
            Logger.LogInformation($"üîó Profile navigation ba≈ülatƒ±lƒ±yor: {username}");
            showSearchResults = false;
            SearchQuery = "";
            StateHasChanged();
            Navigation.NavigateTo($"/profile/{username}");
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Profile navigation hatasƒ±: {ex.Message}");
        }
    }

    private void ViewAllResults()
    {
        showSearchResults = false;
        Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(SearchQuery)}");
    }

    private string GetUserInitials(string username)
    {
        if (string.IsNullOrEmpty(username)) return "?";
        return username.Length >= 2 ? username.Substring(0, 2).ToUpper() : username.ToUpper();
    }

    private void ToggleUserDropdown()
    {
        showUserDropdown = !showUserDropdown;
    }

    private void CloseDropdown()
    {
        showUserDropdown = false;
    }

    private void CloseDropdownAndNavigate(string url)
    {
        showUserDropdown = false;
        Navigation.NavigateTo(url);
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        showUserDropdown = false;
        notificationTimer?.Dispose();
        // Anasayfaya y√∂nlendir
        Navigation.NavigateTo("/");
    }

    private void ToggleNotifications()
    {
        showNotifications = !showNotifications;
        showUserDropdown = false;
        if (showNotifications)
        {
            Task.Run(async () => await LoadNotifications());
        }
    }

    private async Task LoadNotifications()
    {
        try
        {
            if (!AuthService.IsAuthenticated) return;

            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.GetAsync("https://apiservice/api/notifications?pageSize=20");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);

                if (apiResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                {
                    notifications.Clear();
                    unreadNotificationCount = apiResponse.GetProperty("unreadCount").GetInt32();

                    if (apiResponse.TryGetProperty("notifications", out var notificationsElement))
                    {
                        foreach (var notificationElement in notificationsElement.EnumerateArray())
                        {
                            var notification = new NotificationResult
                            {
                                Id = notificationElement.GetProperty("id").GetInt32(),
                                Type = notificationElement.GetProperty("type").GetInt32(),
                                Content = notificationElement.GetProperty("content").GetString() ?? "",
                                IsRead = notificationElement.GetProperty("isRead").GetBoolean(),
                                CreatedAt = notificationElement.GetProperty("createdAt").GetDateTime()
                            };

                            if (notificationElement.TryGetProperty("fromUser", out var fromUserElement) && fromUserElement.ValueKind != JsonValueKind.Null)
                            {
                                notification.FromUser = new NotificationUser
                                {
                                    Id = fromUserElement.GetProperty("id").GetInt32(),
                                    Username = fromUserElement.GetProperty("username").GetString() ?? "",
                                    ProfilePhotoUrl = fromUserElement.TryGetProperty("profilePhotoUrl", out var photoElement) ? photoElement.GetString() : null
                                };
                            }

                            notifications.Add(notification);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Bildirimler y√ºkleme hatasƒ±: {ex.Message}");
        }
    }

    private void StartNotificationTimer()
    {
        // Her 30 saniyede bir bildirimleri ve mesajlarƒ± kontrol et
        notificationTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadNotifications();
                await LoadUnreadMessageCount();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task HandleNotificationClick(NotificationResult notification)
    {
        if (!notification.IsRead)
        {
            await MarkNotificationAsRead(notification.Id);
            notification.IsRead = true;
            unreadNotificationCount = Math.Max(0, unreadNotificationCount - 1);
        }

        showNotifications = false;

        // Bildirim t√ºr√ºne g√∂re y√∂nlendirme
        if (notification.Type == 1 || notification.Type == 2) // FriendRequest or FriendRequestAccepted
        {
            if (notification.FromUser != null)
            {
                Navigation.NavigateTo($"/profile/{notification.FromUser.Username}");
            }
        }

        StateHasChanged();
    }

    private async Task MarkNotificationAsRead(int notificationId)
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            await httpClient.PostAsync($"https://apiservice/api/notifications/{notificationId}/mark-read", null);
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Bildirim okuma i≈üaretleme hatasƒ±: {ex.Message}");
        }
    }

    private async Task MarkAllNotificationsRead()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.PostAsync("https://apiservice/api/notifications/mark-all-read", null);
            if (response.IsSuccessStatusCode)
            {
                foreach (var notification in notifications)
                {
                    notification.IsRead = true;
                }
                unreadNotificationCount = 0;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå T√ºm bildirimleri okuma i≈üaretleme hatasƒ±: {ex.Message}");
        }
    }

    private void ViewAllNotifications()
    {
        showNotifications = false;
        Navigation.NavigateTo("/notifications");
    }

    private async Task LoadUnreadMessageCount()
    {
        try
        {
            if (!AuthService.IsAuthenticated) return;

            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.GetAsync("https://apiservice/api/messages/unread-count");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content);

                if (apiResponse.TryGetProperty("success", out var successElement) && successElement.GetBoolean())
                {
                    unreadMessageCount = apiResponse.GetProperty("unreadCount").GetInt32();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Okunmamƒ±≈ü mesaj sayƒ±sƒ± y√ºkleme hatasƒ±: {ex.Message}");
        }
    }

    private void NavigateToMessages()
    {
        try
        {
            Logger.LogInformation("üí¨ Messages navigation ba≈ülatƒ±lƒ±yor");
            
            // Auth kontrol√º
            if (!AuthService.IsAuthenticated)
            {
                Logger.LogWarning("‚ùå Messages: Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü, login'e y√∂nlendiriliyor");
                Navigation.NavigateTo("/login");
                return;
            }
            
            // Messages sayfasƒ±na g√ºvenli navigation
            Navigation.NavigateTo("/messages", forceLoad: false);
            Logger.LogInformation("‚úÖ Messages navigation ba≈üarƒ±lƒ±");
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Messages navigation hatasƒ±: {ex.Message}");
            Logger.LogError($"‚ùå Stack trace: {ex.StackTrace}");
            
            // Fallback: force reload ile tekrar dene
            try
            {
                Logger.LogInformation("üîÑ Messages navigation fallback deneniyor");
                Navigation.NavigateTo("/messages", forceLoad: true);
            }
            catch (Exception fallbackEx)
            {
                Logger.LogError($"‚ùå Messages navigation fallback hatasƒ±: {fallbackEx.Message}");
            }
        }
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1) return "az √∂nce";
        if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes}dk √∂nce";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours}sa √∂nce";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays}g√ºn √∂nce";
        
        return dateTime.ToString("dd MMM");
    }

    private async Task LoadCategories()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiService");
            var response = await httpClient.GetAsync("https://apiservice/api/categories");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiCategories = JsonSerializer.Deserialize<JsonElement>(content);
                
                categories.Clear();
                foreach (var categoryElement in apiCategories.EnumerateArray())
                {
                    var category = new CategoryResult
                    {
                        Id = categoryElement.GetProperty("id").GetInt32(),
                        Name = categoryElement.GetProperty("name").GetString() ?? "",
                        Slug = categoryElement.GetProperty("slug").GetString() ?? "",
                        Color = categoryElement.TryGetProperty("color", out var colorElement) ? colorElement.GetString() ?? "" : "",
                        TopicCount = categoryElement.GetProperty("topicCount").GetInt32()
                    };
                    categories.Add(category);
                }
                
                Logger.LogInformation($"‚úÖ {categories.Count} kategori y√ºklendi");
            }
            else
            {
                Logger.LogError($"‚ùå Categories API hatasƒ±: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"‚ùå Categories y√ºkleme hatasƒ±: {ex.Message}");
        }
    }

    public class UserSearchResult
    {
        public int Id { get; set; }
        public string Username { get; set; } = "";
        public string Email { get; set; } = "";
        public string? ProfilePhotoUrl { get; set; }
        public int EntryCount { get; set; }
        public int FollowerCount { get; set; }
    }

    public class NotificationResult
    {
        public int Id { get; set; }
        public int Type { get; set; }
        public string Content { get; set; } = "";
        public bool IsRead { get; set; }
        public DateTime CreatedAt { get; set; }
        public NotificationUser? FromUser { get; set; }
    }

    public class NotificationUser
    {
        public int Id { get; set; }
        public string Username { get; set; } = "";
        public string? ProfilePhotoUrl { get; set; }
    }

    public class CategoryResult
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Slug { get; set; } = "";
        public string Color { get; set; } = "";
        public int TopicCount { get; set; }
    }
}